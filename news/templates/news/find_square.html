{% extends 'news/base.html' %}
{% load static %}

{% block title %}Find the Square Trainer{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'chessboardjs-1.0.0/css/chessboard-1.0.0.min.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
  }

  .trainer-container {
    padding: 1rem;
  }

  /* Responsive Chessboard */
  #board-container {
    position: relative;
    width: 100%;
    max-width: 500px;
    aspect-ratio: 1 / 1;
  }

  #board {
    width: 100% !important;
    height: 100% !important;
  }

  /* Floating target overlay */
  #target-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.75);
    color: #fff;
    font-weight: 600;
    font-size: 2rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    display: none;
    z-index: 999;
    pointer-events: none;
  }

  .stats-panel {
    flex: 1;
    min-width: 250px;
    max-width: 400px;
  }

  .stat-item {
    font-size: 1rem;
    padding: 0.3rem;
    border-radius: 0.4rem;
  }

  .timer-box {
    margin-top: 0.5rem;
    font-size: 1.1rem;
  }

  .leaderboard {
    overflow-x: auto;
  }

  .custom-leaderboard th, 
  .custom-leaderboard td {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    #board-container {
      max-width: 100%;
    }

    .stats-panel {
      max-width: 100%;
      margin-top: 1rem;
    }

    .stat-item {
      font-size: 0.9rem;
    }
  }

  /* Square highlights */
  .highlight-correct { background-color: #d4edda !important; }
  .highlight-wrong { background-color: #f8d7da !important; }
</style>

<audio id="correctSound" src="{% static 'sound/puzzle-correct.mp3' %}"></audio>
<audio id="wrongSound" src="{% static 'sound/puzzle-wrong.mp3' %}"></audio>

<div class="trainer-container">
  {% if not request.user.is_authenticated %}
  <div class="alert alert-warning text-center">
    You must <a href="{% url 'login' %}">log in</a> to save results.
  </div>
  {% endif %}

  <div class="d-flex justify-content-center flex-wrap gap-3 align-items-start">
    <!-- Board -->
    <div id="board-container" class="flex-shrink-0">
      <div id="target-overlay"></div>
      <div id="board" class="mx-auto"></div>
    </div>

    <!-- Stats -->
    <div class="stats-panel d-flex flex-column align-items-center gap-2">
      <div class="d-flex w-100 flex-column flex-md-row gap-2">
        <div class="stat-item bg-light text-success flex-fill text-center">
          <strong>Correct:</strong> <span id="correct-count">0</span>
        </div>
        <div class="stat-item bg-light text-danger flex-fill text-center">
          <strong>Wrong:</strong> <span id="wrong-count">0</span>
        </div>
      </div>

      <div class="timer-box w-100 text-center">
        <strong>‚è± Time:</strong> <span id="timer" class="text-primary">2:00</span>
      </div>

      <div id="feedback" class="text-center w-100"></div>

      <div class="text-center w-100 mt-auto">
        <button id="start-btn" class="btn btn-success w-100">Start Training</button>
      </div>
    </div>
  </div>
</div>

<!-- Leaderboard -->
<div class="leaderboard mt-5">
  <h4 class="text-center text-primary">üèÜ Top Players</h4>
  <div class="table-responsive">
    <table class="table table-striped custom-leaderboard text-center mt-3">
      <thead class="table-primary">
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>‚úì Correct</th>
          <th>‚úó Wrong</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        {% for player in top_players %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ player.user__username }}</td>
          <td>{{ player.total_correct }}</td>
          <td>{{ player.total_wrong }}</td>
          <td>{{ player.score }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'chessboardjs-1.0.0/js/chessboard-1.0.0.min.js' %}"></script>

<script>
  $(document).ready(function () {
    const $feedback = $('#feedback');
    const $correct = $('#correct-count');
    const $wrong = $('#wrong-count');
    const $timer = $('#timer');
    const $startBtn = $('#start-btn');
    const $overlay = $('#target-overlay');

    const correctSound = document.getElementById('correctSound');
    const wrongSound = document.getElementById('wrongSound');

    let board = Chessboard('board', {
      position: 'empty',
      draggable: false,
      pieceTheme: '',
    });

    // ‚úÖ Auto resize board on window resize
    $(window).on('resize', function () {
      board.resize();
    });
    setTimeout(() => board.resize(), 200);

    let correctCount = 0;
    let wrongCount = 0;
    let targetSquare = '';
    let timerInterval = null;
    let timeRemaining = 120;

    function getRandomSquare() {
      const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
      const ranks = ['1', '2', '3', '4', '5', '6', '7', '8'];
      return files[Math.floor(Math.random() * 8)] + ranks[Math.floor(Math.random() * 8)];
    }

    function newTargetSquare() {
      const orientation = Math.random() < 0.5 ? 'white' : 'black';
      board.orientation(orientation);
      targetSquare = getRandomSquare();

      // Show floating overlay inside board
      $overlay
        .stop(true, true)
        .text(targetSquare.toUpperCase())
        .fadeIn(200)
        .delay(1000)
        .fadeOut(500);

      $feedback.text('').removeClass('alert-success alert-danger');
    }

    function updateTimerDisplay() {
      const mins = Math.floor(timeRemaining / 60);
      const secs = timeRemaining % 60;
      $timer.text(`${mins}:${secs < 10 ? '0' : ''}${secs}`);
      if (timeRemaining <= 30 && !$timer.hasClass('text-danger')) {
        $timer.addClass('text-danger').removeClass('text-primary');
      }
    }

    function endGame() {
      clearInterval(timerInterval);
      $overlay.hide();
      $startBtn.text('Play Again').show();
      $('#timer').removeClass('text-danger');

      $.ajax({
        type: 'POST',
        url: '',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          correct: correctCount,
          wrong: wrongCount
        }
      });
    }

    function startGame() {
      correctCount = 0;
      wrongCount = 0;
      timeRemaining = 120;

      $correct.text(0);
      $wrong.text(0);
      $timer.text('2:00').removeClass('text-danger').addClass('text-primary');
      newTargetSquare();
      $startBtn.hide();

      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) endGame();
      }, 1000);
    }

    function playSound(audio) {
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }

    $(document).on('click', '.square-55d63', function () {
      if (timeRemaining <= 0 || !targetSquare) return;

      const clicked = $(this).attr('data-square');
      const $square = $(this);

      if (clicked === targetSquare) {
        correctCount++;
        $correct.text(correctCount);
        $feedback.text('Correct!').addClass('alert alert-success');
        playSound(correctSound);
        $square.addClass('highlight-correct');
        setTimeout(() => $square.removeClass('highlight-correct'), 500);
      } else {
        wrongCount++;
        $wrong.text(wrongCount);
        $feedback.text('Wrong!').addClass('alert alert-danger');
        playSound(wrongSound);
        $square.addClass('highlight-wrong');
        setTimeout(() => $square.removeClass('highlight-wrong'), 500);
      }

      setTimeout(newTargetSquare, 800);
    });

    $startBtn.on('click', startGame);
  });
</script>
{% endblock %}
