{% extends 'news/base.html' %}
{% load static %}

{% block title %}Find the Square Trainer{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'chessboardjs-1.0.0/css/chessboard-1.0.0.min.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* Responsive styles for small screens */
</style>

<audio id="correctSound" src="{% static 'sound/puzzle-correct.mp3' %}"></audio>
<audio id="wrongSound" src="{% static 'sound/puzzle-wrong.mp3' %}"></audio>

<div class="trainer-container">
  {% if not request.user.is_authenticated %}
  <div class="alert alert-warning text-center">You must <a href="{% url 'login' %}">log in</a> to save results.</div>
  {% endif %}

  <div class="d-flex justify-content-center gap-3 flex-wrap align-items-start">

    <div id="board-container" style="width: 500px;">
      <div id="board" class="mx-auto"></div>
    </div>

    <div class="stats-panel d-flex flex-column align-items-center gap-1">
      <div id="target-square" class="w-100 text-center">Click Start to begin!</div>

      <div class="d-flex w-100 flex-column flex-md-row gap-1">
        <div class="stat-item text-success flex-fill"><strong>Correct:</strong> <span id="correct-count">0</span></div>
        <div class="stat-item text-danger flex-fill"><strong>Wrong:</strong> <span id="wrong-count">0</span></div>
      </div>


      <div class="timer-box w-100">
        <strong>‚è± Time:</strong> <span id="timer" class="text-primary">2:00</span>
      </div>

      <div id="feedback" class="text-center"></div>

      <div class="text-center w-100 mt-auto">
        <button id="start-btn" class="btn btn-success">Start Training</button>
      </div>
    </div>
  </div>
</div>

<div class="leaderboard mt-5">
  <h4 class="text-center text-primary">üèÜ Top Players</h4>
  <table class="table custom-leaderboard text-center mt-3">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Username</th>
        <th>‚úì Correct</th>
        <th>‚úó Wrong</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody>
      {% for player in top_players %}
      <tr>
        <td data-label="Rank" class="counter">{{ forloop.counter }}</td>
        <td data-label="Username" class="name">{{ player.user__username }}</td>
        <td data-label="Correct" class="correct">{{ player.total_correct }}</td>
        <td data-label="Wrong" class="wrong">{{ player.total_wrong }}</td>
        <td data-label="Score" class="score">{{ player.score }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'chessboardjs-1.0.0/js/chessboard-1.0.0.min.js' %}"></script>

<script>
  $(document).ready(function () {
    const $targetSquare = $('#target-square');
    const $feedback = $('#feedback');
    const $correct = $('#correct-count');
    const $wrong = $('#wrong-count');
    const $timer = $('#timer');
    const $startBtn = $('#start-btn');

    const correctSound = document.getElementById('correctSound');
    const wrongSound = document.getElementById('wrongSound');

    let board = Chessboard('board', {
      position: 'empty',
      draggable: false,
      pieceTheme: '',
    });

    let correctCount = 0;
    let wrongCount = 0;
    let targetSquare = '';
    let timerInterval = null;
    let timeRemaining = 120;

    function getRandomSquare() {
      const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
      const ranks = ['1', '2', '3', '4', '5', '6', '7', '8'];
      return files[Math.floor(Math.random() * 8)] + ranks[Math.floor(Math.random() * 8)];
    }

    function newTargetSquare() {
      const orientation = Math.random() < 0.5 ? 'white' : 'black';
      board.orientation(orientation);
      targetSquare = getRandomSquare();
      $targetSquare.text('Find: ' + targetSquare).addClass('highlight');
      setTimeout(() => $targetSquare.removeClass('highlight'), 300);
      $feedback.text('').removeClass('alert-success alert-danger');
    }

    function updateTimerDisplay() {
      const mins = Math.floor(timeRemaining / 60);
      const secs = timeRemaining % 60;
      $timer.text(`${mins}:${secs < 10 ? '0' : ''}${secs}`);
      if (timeRemaining <= 30 && !$timer.hasClass('text-danger')) {
        $timer.addClass('text-danger').removeClass('text-primary');
      }
    }

    function endGame() {
      clearInterval(timerInterval);
      $targetSquare.text('Training complete!');
      $startBtn.text('Play Again').show();
      $('#timer').removeClass('text-danger'); // Stop pulsing animation

      $.ajax({
        type: 'POST',
        url: '', // same URL
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          correct: correctCount,
          wrong: wrongCount
        },
        success: function (response) {
          console.log('Result saved:', response);
        },
        error: function () {
          console.error('Result not saved.');
        }
      });
    }

    function startGame() {
      correctCount = 0;
      wrongCount = 0;
      timeRemaining = 120;

      $correct.text(0);
      $wrong.text(0);
      $timer.text('2:00').removeClass('text-danger').addClass('text-primary');
      newTargetSquare();
      $startBtn.hide();
      $feedback.removeClass('alert-info');

      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) endGame();
      }, 1000);
    }

    function playSound(audio) {
      audio.currentTime = 0;
      audio.play().catch(e => console.log('Audio error:', e));
    }

    $(document).on('click', '.square-55d63', function () {
      if (timeRemaining <= 0 || !targetSquare) return;

      const clicked = $(this).attr('data-square');
      const $square = $(this);

      if (clicked === targetSquare) {
        correctCount++;
        $correct.text(correctCount);
        $feedback.text('Correct!').addClass('alert alert-success');
        playSound(correctSound);
        $square.addClass('highlight-correct'); // Use a custom class for correct
        setTimeout(() => $square.removeClass('highlight-correct'), 500);
      } else {
        wrongCount++;
        $wrong.text(wrongCount);
        $feedback.text('Wrong!').addClass('alert alert-danger');
        playSound(wrongSound);
        $square.addClass('highlight-wrong'); // Use a custom class for wrong
        setTimeout(() => $square.removeClass('highlight-wrong'), 500);
      }

      setTimeout(newTargetSquare, 800);
    });

    $startBtn.on('click', startGame);

    // Add styles for square highlights to avoid inline styles
    $('head').append('<style>.highlight-correct { background-color: #d4edda !important; } .highlight-wrong { background-color: #f8d7da !important; }</style>');
  });
</script>
{% endblock %}