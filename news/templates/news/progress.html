{% extends 'news/base.html' %}
{% load static %}

{% block title %}Your Chess Progress{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .profile-header {
        background: rgba(40, 40, 40, 0.7);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 20px;
        position: relative;
    }

    .profile-img {
        width: 90px;
        height: 90px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .edit-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        font-size: 0.9rem;
        padding: 6px 12px;
        border-radius: 6px;
        transition: 0.3s;
    }

    .edit-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .profile-name {
        font-weight: 700;
        font-size: 1.2rem;
        color: #fff;
    }

    .profile-sub {
        color: #aaa;
        font-size: 0.95rem;
    }

    .profile-bio {
        color: #f8f8f8;
        margin-top: 5px;
        font-size: 0.9rem;
    }

    .profile-stats {
        font-size: 0.85rem;
        color: #aaa;
        margin-top: 10px;
    }

    .profile-stats span {
        margin-right: 15px;
    }

    .card-glass {
        background: rgba(40, 40, 40, 0.45);
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.125);
    }

    .stat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
</style>

<div class="container py-3">

    <!-- Profile Header -->
    <div class="profile-header shadow mb-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
            <div class="d-flex align-items-center flex-wrap">
                <img src="{% if request.user.userprofile.image %}{{ request.user.userprofile.image.url }}{% else %}{% static 'profile_images/user.png' %}{% endif %}"
                    alt="Profile Photo" class="profile-img me-3 mb-2 mb-sm-0">
                <div>
                    <div class="d-flex align-items-center flex-nowrap justify-content-start">
                        <span class="profile-name me-2">{{ user.username|default:"Guest Player" }}</span>
                        <span class="fi fi-bd"></span>
                    </div>
                    <div class="profile-sub">
                        <i class="bi bi-geo-alt"></i> Feni
                    </div>
                    <div class="profile-bio">
                        {{ request.user.userprofile.bio|default:"Add Description Here" }}
                    </div>
                    <div class="profile-stats">
                        <span><b>{{ user.date_joined.date }}</b> Joined</span>
                    </div>
                </div>
            </div>
            <div class="ms-2 mt-2 mt-sm-0">
                <a href="{% url 'edit_profile' %}" class="text-decoration-none">
                    <button class="edit-btn">Edit Profile</button>
                </a>
            </div>
        </div>
    </div>

    <!-- Title -->
    <div class="text-center mb-4">
        <h3 class="mb-4 text-white fw-bold">Your Puzzle Progress</h3>
    </div>

    <!-- Charts and Stats -->
    <div class="row g-4">
        <!-- Chart -->
        <div class="col-lg-8 col-md-12">
            <div class="card card-glass p-4 h-100 shadow">
                <h5 class="mb-3 text-white fw-bold">Time Taken per Puzzle</h5>
                <div class="chart-container" style="position: relative; height:350px;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="col-lg-4 col-md-12">
            <h5 class="text-white fw-bold mb-3">Stats at a Glance</h5>

            <div class="card card-glass stat-card p-3 mb-3">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-white">
                        <i class="bi bi-clock-history stat-icon"></i>
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Average Time</h6>
                        <h4 class="fw-bold text-white mb-0">{{ average_time|default:"0s" }}</h4>
                    </div>
                </div>
            </div>

            <div class="card card-glass stat-card p-3 mb-3">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-white">
                        <i class="bi bi-check2-square stat-icon"></i>
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Puzzles Solved</h6>
                        <h4 class="fw-bold text-white mb-0">{{ puzzles_solved|default:"0" }}</h4>
                    </div>
                </div>
            </div>

            <div class="card card-glass stat-card p-3">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-white">
                        <i class="bi bi-graph-up-arrow stat-icon"></i>
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Success Rate</h6>
                        <h4 class="fw-bold text-white mb-0">{{ success_rate|default:"0%" }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements -->
    <div class="row g-4 mt-3">
        <div class="col-12">
            <h3 class="mb-1 text-white fw-bold">Achievements</h3>
        </div>

        {% if puzzles_solved >= 5 %}
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="card card-glass stat-card p-3 h-100 d-flex align-items-center">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <img src="{% static 'progress/puzzle.png' %}" alt="Puzzle Icon" class="stat-icon img-fluid"
                            style="width: 50px; height: 50px;">
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Puzzle Beginner</h6>
                        <p class="fw-bold text-white mb-0">You correctly solved 5 Puzzles!</p>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="card card-glass stat-card p-3 h-100 d-flex justify-content-center align-items-center">
                <img src="{% static 'progress/lock.png' %}" alt="Locked Icon" class="stat-icon img-fluid"
                    style="width: 50px; height: 50px;">
            </div>
        </div>
        {% endif %}
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ labels| safe }};
    const data = {
        labels: labels,
        datasets: [{
            label: 'Time Taken (seconds)',
            data: {{ data| safe }},
    fill: true,
        backgroundColor: 'rgba(255, 255, 255, 0.1)',
            borderColor: '#fff',
                pointBackgroundColor: '#fff',
                    pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#fff',
                                tension: 0.4
        }]
    };

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Time Taken (seconds)',
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { size: 14, weight: 'bold' }
                    },
                    ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                    grid: { color: 'rgba(255, 255, 255, 0.15)' }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Puzzle Number',
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { size: 14, weight: 'bold' }
                    },
                    ticks: { maxRotation: 45, autoSkip: true, color: 'rgba(255, 255, 255, 0.7)' },
                    grid: { display: false }
                }
            }
        }
    };

    new Chart(document.getElementById('progressChart'), config);
</script>
{% endblock %}