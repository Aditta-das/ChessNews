{% extends 'news/base.html' %}
{% load static %}

{% block title %}Your Chess Progress{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .profile-header {
        background: rgba(40, 40, 40, 0.7);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 20px;
        position: relative;
    }

    .profile-img {
        width: 90px;
        height: 90px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .edit-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        font-size: 0.9rem;
        padding: 6px 12px;
        border-radius: 6px;
        transition: 0.3s;
    }

    .edit-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .profile-name {
        font-weight: 700;
        font-size: 1.2rem;
        color: #fff;
    }

    .profile-sub {
        color: #aaa;
        font-size: 0.95rem;
    }

    .profile-bio {
        color: #f8f8f8;
        margin-top: 5px;
        font-size: 0.9rem;
    }

    .profile-stats {
        font-size: 0.85rem;
        color: #aaa;
        margin-top: 10px;
    }

    .profile-stats span {
        margin-right: 15px;
    }

    @media (max-width: 576px) {
        .profile-header {
            text-align: center;
        }

        .edit-btn {
            position: static;
            margin-top: 10px;
        }

        .profile-img {
            margin-bottom: 10px;
        }
    }

    .card-glass {
        background: rgba(40, 40, 40, 0.45);
        /* Dark semi-transparent background */
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.125);
    }

    /* Stat card specific styles */
    .stat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
</style>

<div class="container py-2">
    <div class="profile-header shadow mb-4">
        <div class="d-flex flex-wrap align-items-center">
            <img src="{% if request.user.userprofile.image %}{{ request.user.userprofile.image.url }}{% else %}{% static 'profile_images/user.png' %}{% endif %}"
                alt="Profile Photo" class="profile-img me-3">

            <div class="flex-grow-1">
                <div class="d-flex align-items-center flex-wrap">
                    <span class="profile-name me-2">{{ user.username|default:"Guest Player" }}</span>
                    <span class="fi fi-bd"></span>
                </div>
                <div class="profile-sub">
                    <!-- {{ user.first_name }} {{ user.last_name }} -->
                    <i class="bi bi-geo-alt"></i> Feni
                </div>
                <div class="profile-bio">
                    {{ request.user.userprofile.bio|default:"Add Description Here" }}
                </div>
                <div class="profile-stats">
                    <span><b>{{ user.date_joined.date }}</b> Joined</span>
                    <!-- <span>41 Friends</span> -->
                    <!-- <span>44 Views</span> -->
                    <!-- <span class="text-success">Online now</span> -->
                </div>
            </div>
            <div>
                <a href="{% url 'edit_profile' %}" class="text-decoration-none">
                    <button class="edit-btn">Edit Profile</button>
                </a>
            </div>
        </div>
    </div>

    <div class="text-center mb-4">
        <h3 class="mb-4 text-white fw-bold display-8">Your Puzzle Progress</h3>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card card-glass p-4 h-100 shadow">
                <h5 class="mb-3 text-white fw-bold">Time Taken per Puzzle</h5>
                <div class="chart-container" style="position: relative; height:350px;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <h5 class="text-white fw-bold mb-3">Stats at a Glance</h5>

            <div class="card card-glass stat-card p-3 mb-3">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-white">
                        <i class="bi bi-clock-history stat-icon"></i>
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Average Time</h6>
                        <h4 class="fw-bold text-white mb-0">{{ average_time|default:"34.5s" }}</h4>
                    </div>
                </div>
            </div>

            <div class="card card-glass stat-card p-3 mb-3">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-white">
                        <i class="bi bi-check2-square stat-icon"></i>
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Puzzles Solved</h6>
                        <h4 class="fw-bold text-white mb-0">{{ puzzles_solved|default:"128" }}</h4>
                    </div>
                </div>
            </div>

            <div class="card card-glass stat-card p-3">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-white">
                        <i class="bi bi-graph-up-arrow stat-icon"></i>
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Success Rate</h6>
                        <h4 class="fw-bold text-white mb-0">{{ success_rate|default:"89%" }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-lg-12 mb-4">
            <h3 class="mb-1 text-white fw-bold">Achievements</h3>
        </div>
        {% if puzzles_solved >= 4 %}
        <div class="col-lg-4 col-md-6">
            <div class="card card-glass stat-card p-3 mb-3">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <img src="{% static 'progress/puzzle.png' %}" alt="Puzzle Icon" class="stat-icon img-fluid"
                            style="width: 50px; height: 50px;">
                    </div>
                    <div>
                        <h6 class="text-white-50 mb-0">Puzzle Beginner</h6>
                        <p class="fw-bold text-white mb-0">You correctly solved 10 Puzzles!</p>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-lg-4 col-md-6">
            <div class="card card-glass stat-card p-3 mb-3 d-flex justify-content-center align-items-center"
                style="height: 100px;">
                <img src="{% static 'progress/lock.png' %}" alt="Locked Icon" class="stat-icon img-fluid"
                    style="width: 50px; height: 50px;">
            </div>
        </div>
        {% endif %}
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ labels| safe }};
    const data = {
        labels: labels,
        datasets: [{
            label: 'Time Taken (seconds)',
            data: {{ data| safe }},
    fill: true, // Set to true to create a filled area under the line
        backgroundColor: 'rgba(255, 255, 255, 0.1)', // Subtle fill color
            borderColor: '#fff',
                pointBackgroundColor: '#fff', // Color of the data points
                    pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#fff',
                                tension: 0.4 // Smoother curve
        }]
    };

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false, // Important for custom container size
            plugins: {
                legend: {
                    display: false // Legend is redundant with the chart title
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Time Taken (seconds)',
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.15)' // Lighter grid lines
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Puzzle Number',
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        maxRotation: 45,
                        autoSkip: true, // Allow chart.js to intelligently skip labels if too crowded
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        display: false // Hide vertical grid lines for a cleaner look
                    }
                }
            }
        }
    };

    new Chart(
        document.getElementById('progressChart'),
        config
    );
</script>
{% endblock %}