{% extends 'news/base.html' %}
{% load static %}

{% block title %}Chess Puzzles{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'chessboardjs-1.0.0/css/chessboard-1.0.0.min.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* Responsive styles for small screens */
  @media (max-width: 767px) {
    #main-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 auto;
    }

    #board-container {
      width: 100% !important;
      justify-content: center;
      order: 2;
    }

    #board {
      width: 100% !important;
      height: auto !important;
      aspect-ratio: 1/1;
    }

    .puzzle-timer {
      display: none;
    }

    #notation-box {
      width: auto !important;
      height: auto !important;
      margin: -35px auto;
    }

    .puzzle-info {
      order: 1;
    }

    #puzzle-title-small {
      display: block;
      font-size: 1rem;
    }

    #controls-container {
      order: 3;
      width: 100% !important;
    }

    /* On small screens, hide the text and make icons larger */
    .btn-icon {
      display: inline-block;
    }

    .notation-btn-img {
      width: 24px;
      height: 24px;
    }

    .move-notation-text {
      font-size: 0.8rem;
      margin: 0 auto;
    }

    #puzzle-turn {
      display: none;
    }


    #reset-btn,
    #hint-btn,
    #next-btn {
      width: 50% !important;
      margin: 0 auto;
      padding: 10px;
      font-size: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    /* New CSS for mobile puzzle list */
    .mobile-puzzle-btn {
      width: 100%;
      margin-bottom: 10px;
    }

    .modal-body {
      overflow-y: auto;
    }
  }

  /* On large screens, show both the text and the icons */
  .btn-icon {
    display: inline-block;
    margin-right: 8px;
    /* Spacing between icon and text */
  }

  .notation-btn-img {
    width: 24px;
    height: 24px;
  }
</style>

<audio id="correctSound" src="{% static 'sound/puzzle-correct.mp3' %}"></audio>
<audio id="wrongSound" src="{% static 'sound/puzzle-wrong.mp3' %}"></audio>
<audio id="moveSound">
  <source src="{% static 'sound/move-self.mp3' %}" type="audio/mpeg">
</audio>
<audio id="captureSound">
  <source src="{% static 'sound/capture.mp3' %}" type="audio/mpeg">
</audio>
<audio id="checkSound">
  <source src="{% static 'sound/move-check.mp3' %}" type="audio/mpeg">
</audio>

<div id="main-layout" class="d-flex justify-content-center gap-4 flex-wrap">
  <div id="puzzle-list" class="d-none d-lg-block" style="width: 273px; max-height: 80vh; overflow-y: auto;">
    {% for puzzle in puzzles %}
    {% if puzzle.id in solved_ids and request.user.is_authenticated %}
    <button class="puzzle-btn btn solved-puzzle mb-2 w-100" data-fen="{{ puzzle.fen }}"
      data-solution="{{ puzzle.solution }}" data-title="{{ puzzle.title }}" data-turn="{{ puzzle.turn }}"
      data-index="{{ forloop.counter0 }}" data-puzzle-id="{{ puzzle.id }}" {% if puzzle.quote %}
      data-quote-name="{{ puzzle.quote.name }}" data-quote-text="{{ puzzle.quote.Quote }}" {% endif %}>
      <strong class="text-white">{{ puzzle.title }}</strong><br>
    </button>
    {% else %}
    <button class="puzzle-btn btn unsolved-puzzle mb-2 w-100" data-fen="{{ puzzle.fen }}"
      data-solution="{{ puzzle.solution }}" data-title="{{ puzzle.title }}" data-turn="{{ puzzle.turn }}"
      data-index="{{ forloop.counter0 }}" data-puzzle-id="{{ puzzle.id }}" {% if puzzle.quote %}
      data-quote-name="{{ puzzle.quote.name }}" data-quote-text="{{ puzzle.quote.Quote }}" {% endif %}>
      <strong class="text-white">{{ puzzle.title }}</strong><br>
    </button>
    {% endif %}
    {% empty %}
    <div class="alert alert-info">No puzzles available yet.</div>
    {% endfor %}
  </div>

  <div id="board-container" style="width: 500px;">
    <div class="puzzle-info mb-3 text-center">
      <div class="d-flex justify-content-center mb-3 d-lg-none">
        <button id="puzzle-title-small" class="btn btn-primary w-100" data-bs-toggle="modal"
          data-bs-target="#mobile-puzzle-modal">Select a puzzle</button>
      </div>
      <p id="puzzle-instruction" class="text-muted"></p>
      <code id="fen-display" class="d-none"></code>
    </div>

    <div id="board" class="mx-auto"></div>

  </div>

  <div id="controls-container" style="width: 295px;">
    <p class="puzzle-timer text-center">⏱️ Time: <span id="timer">0</span> sec</p>
    <div id="notation-box" class="mb-3 p-2" style="max-height: 50vh; overflow-y: auto;">
      <h4 id="puzzle-title-large" class="d-none d-lg-block">Select a puzzle</h4>
      <p id="puzzle-turn"></p>
      <hr>
      <h5 class="move-notation-text text-center text-white">Move Notation</h5>
      <div id="move-history"></div>
    </div>
    <div id="puzzle-status" class="text-center mt-3 d-none"></div>
    <div class="row g-2 align-items-center">
      <div id="quote-box" class="col-lg-12 card text-center mb-3 quote-none">
        <div class="card-body">
          <h5 id="quote-author" class="card-title"></h5>
          <p id="quote-text" class="card-text"></p>
        </div>
      </div>
      <div class="col-12 col-lg-6 d-flex flex-row justify-content-between gap-1.6">
        <button id="reset-btn" class="btn btn-secondary btn-md flex-grow-1">
          <span class="btn-icon"><img src="{% static 'buttons/reset.png' %}" class="notation-btn-img"
              alt="Reset"></span>
          <span class="btn-text">Reset</span>
        </button>
        <button id="hint-btn" class="btn btn-info btn-md flex-grow-1">
          <span class="btn-icon"><img src="{% static 'buttons/hint.png' %}" class="notation-btn-img" alt="Hint"></span>
          <span class="btn-text">Hint</span>
        </button>
        <button id="next-btn" class="btn next-puzzle btn-md flex-grow-1" style="display:none;">
          <span class="btn-icon"><img src="{% static 'buttons/next.png' %}" class="notation-btn-img"
              alt="Next Puzzle"></span>
          <span class="btn-text">Next</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for mobile puzzle list -->
<div class="modal fade" id="mobile-puzzle-modal" tabindex="-1" aria-labelledby="mobile-puzzle-modal-label"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mobile-puzzle-modal-label">Puzzles</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="mobile-puzzle-list">
          {% for puzzle in puzzles %}
          {% if puzzle.id in solved_ids and request.user.is_authenticated %}
          <button class="puzzle-btn btn solved-puzzle mb-2 w-100" data-fen="{{ puzzle.fen }}"
            data-solution="{{ puzzle.solution }}" data-title="{{ puzzle.title }}" data-turn="{{ puzzle.turn }}"
            data-index="{{ forloop.counter0 }}" data-puzzle-id="{{ puzzle.id }}" data-bs-dismiss="modal" {% if
            puzzle.quote %} data-quote-name="{{ puzzle.quote.name }}" data-quote-text="{{ puzzle.quote.Quote }}" {%
            endif %}>
            <strong class="text-white">{{ puzzle.title }}</strong><br>
          </button>
          {% else %}
          <button class="puzzle-btn btn unsolved-puzzle mb-2 w-100" data-fen="{{ puzzle.fen }}"
            data-solution="{{ puzzle.solution }}" data-title="{{ puzzle.title }}" data-turn="{{ puzzle.turn }}"
            data-index="{{ forloop.counter0 }}" data-puzzle-id="{{ puzzle.id }}" data-bs-dismiss="modal" {% if
            puzzle.quote %} data-quote-name="{{ puzzle.quote.name }}" data-quote-text="{{ puzzle.quote.Quote }}" {%
            endif %}>
            <strong class="text-white">{{ puzzle.title }}</strong><br>
          </button>
          {% endif %}
          {% empty %}
          <div class="alert alert-info">No puzzles available yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'chessboardjs-1.0.0/js/chessboard-1.0.0.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).ready(function () {
    const moveSound = document.getElementById('moveSound');
    const captureSound = document.getElementById('captureSound');
    const checkSound = document.getElementById('checkSound');

    function safePlay(audioElement) {
      audioElement.currentTime = 0;
      const playPromise = audioElement.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.warn("Audio play failed:", error);
        });
      }
    }

    function playSoundForMove(move) {
      if (move.flags.includes('c')) {
        safePlay(captureSound);
      } else if (game.in_check()) {
        safePlay(checkSound);
      } else {
        safePlay(moveSound);
      }
    }

    function playSound(src) {
      const audio = new Audio(src);
      audio.currentTime = 0;
      audio.play().catch((err) => {
        console.warn("Audio play failed:", err);
      });
    }

    const $buttons = $('.puzzle-btn');
    const $puzzleTitleSmallButton = $('#puzzle-title-small');
    const $puzzleTitleLarge = $('#puzzle-title-large');
    const $puzzleTurn = $('#puzzle-turn');
    const $fenDisplay = $('#fen-display');
    const $puzzleStatus = $('#puzzle-status');
    const $nextBtn = $('#next-btn');
    const $resetBtn = $('#reset-btn');
    const $hintBtn = $('#hint-btn');
    const $moveHistory = $('#move-history');
    const $controlsContainer = $('#controls-container');
    const $boardContainer = $('#board-container');

    let board = null;
    let game = null;
    let currentSolutionMoves = [];
    let currentMoveIndex = 0;
    let currentPuzzleIndex = 0;
    let currentPuzzleTurn = 'w';
    let currentFen = '';
    let moveHistory = [];

    let solveStartTime = null;
    let timerInterval = null;
    function startTimerDisplay() {
      clearInterval(timerInterval);
      $('#timer').text('0');
      timerInterval = setInterval(function () {
        const secondsPassed = Math.floor((Date.now() - solveStartTime) / 1000);
        $('#timer').text(secondsPassed);
      }, 1000);
    }

    function stopTimerDisplay() {
      clearInterval(timerInterval);
    }

    function initBoard(fen, orientation) {
      if (board) board.destroy();
      board = Chessboard('board', {
        position: fen,
        orientation: orientation,
        draggable: true,
        dropOffBoard: 'snapback',
        pieceTheme: "{% static 'chessboardjs-1.0.0/img/chesspieces/wikipedia/' %}" + '{piece}' + '.png',
        onDragStart: onDragStart,
        onDrop: onDrop,
      });
      $(window).resize(board.resize);
    }

    function onDragStart(source, piece) {
      if ((game.turn() === 'w' && piece.startsWith('b')) ||
        (game.turn() === 'b' && piece.startsWith('w'))) {
        return false;
      }
      if (game.game_over()) return false;
    }
    function normalizeSAN(san) {
      return san.replace(/[+#]/g, '')
        .replace(/=/g, '')
        .toLowerCase();
    }

    // Add this variable at the top of your puzzle JS file
    let wrongCounted = false;

    function onDrop(source, target) {
      const tempGame = new Chess(game.fen());
      const move = tempGame.move({
        from: source,
        to: target,
        promotion: 'q' // Use queen as default for pawn promotions
      });

      if (move === null) {
        showStatus("Illegal move", "wrong"); // Show feedback
        return 'snapback'; // Piece returns to its original spot.
      }

      // --- STEP 2: The move was legal. Now, check if it's the CORRECT puzzle solution. ---
      const userMoveSAN = normalizeSAN(move.san);
      const expectedMoveSAN = normalizeSAN(currentSolutionMoves[currentMoveIndex]);

      if (userMoveSAN === expectedMoveSAN) {
        // --- CORRECT! ---
        // Your move was legal AND correct. We now apply it to the real board.
        const realMove = game.move({ from: source, to: target, promotion: 'q' });

        playSoundForMove(realMove);
        addToMoveHistory(realMove);
        currentMoveIndex++;
        board.position(game.fen(), false); // Update the visual board
        showStatus("Correct!", "correct");

        // ... the rest of the logic for when you get a move right ...
        if (currentMoveIndex >= currentSolutionMoves.length) {
          showStatus("Puzzle solved!", "solved");
          playSound("{% static 'sound/puzzle-correct.mp3' %}");
          stopTimerDisplay();
          const puzzleId = $buttons.eq(currentPuzzleIndex).data('puzzle-id');
          const solveEndTime = Date.now();
          const timeTaken = Math.floor((solveEndTime - solveStartTime) / 1000);

          $.ajax({
            url: `/puzzles/mark_solved/${puzzleId}/`,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
            data: JSON.stringify({ time_taken: timeTaken }),
            success: function () {
              const $btn = $buttons.eq(currentPuzzleIndex);
              $btn.removeClass('unsolved-puzzle').addClass('solved-puzzle');
            }
          });
          $nextBtn.show();
        } else {
          setTimeout(makeOpponentMove, 500);
        }

      } else {
        // --- WRONG! ---
        // Your move was legal, but it was NOT the correct solution for the puzzle.
        showStatus("Wrong move, try again.", "wrong");
        playSound("{% static 'sound/puzzle-wrong.mp3' %}");

        if (!wrongCounted) {
          wrongCounted = true;
          const puzzleId = $buttons.eq(currentPuzzleIndex).data('puzzle-id');
          $.ajax({
            url: `/puzzles/mark_wrong/${puzzleId}/`,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          });
        }

        // The piece returns to its original spot.
        return 'snapback';
      }
    }



    function makeOpponentMove() {
      if (currentMoveIndex >= currentSolutionMoves.length) return;
      const moveSAN = currentSolutionMoves[currentMoveIndex];
      const move = game.move(moveSAN);
      if (!move) {
        showStatus("Error in solution", "wrong");
        return;
      }
      playSoundForMove(move);
      addToMoveHistory(move);
      board.position(game.fen());
      currentMoveIndex++;
      showStatus(`Opponent played ${moveSAN}`, "info");

      if (currentMoveIndex >= currentSolutionMoves.length) {
        showStatus("🎉 Puzzle solved!", "solved");
        $nextBtn.show();
      }
    }

    function loadPuzzle(index) {
      const btn = $buttons.eq(index);
      const fen = btn.data('fen');
      const solution = btn.data('solution').trim();
      const title = btn.data('title');
      const quoteName = btn.data('quote-name');
      const quoteText = btn.data('quote-text');

      const puzzleId = btn.data('puzzle-id');
      localStorage.setItem('lastPuzzleId', puzzleId);

      if (quoteName && quoteText) {
        $('#quote-author').text(quoteName);
        $('#quote-text').html(quoteText);
        $('#quote-box').removeClass('quote-none');
        setTimeout(function () {
          $('#quote-box').fadeOut(500, function () {
            $(this).addClass('quote-none').show();
          });
        }, 5000);
      } else {
        $('#quote-box').addClass('quote-none');
        $('#quote-author').text('');
        $('#quote-text').text('');
      }
      currentPuzzleTurn = btn.data('turn');

      currentPuzzleIndex = index;
      currentSolutionMoves = solution.split(/\s+/);
      currentMoveIndex = 0;
      currentFen = fen;
      moveHistory = [];
      game = new Chess(fen);

      solveStartTime = Date.now();
      startTimerDisplay();

      // Update both the large screen title and the small screen button title
      $puzzleTitleLarge.text(title);
      $puzzleTitleSmallButton.text(title);
      $puzzleTurn.text((currentPuzzleTurn === 'w' ? 'White' : 'Black') + ' to play');
      $fenDisplay.text(fen);
      showStatus("", "");
      $nextBtn.hide();
      updateMoveHistory();

      initBoard(fen, currentPuzzleTurn === 'w' ? 'white' : 'black');

      if (game.turn() !== currentPuzzleTurn) {
        showStatus("Opponent moves first...", "info");
        setTimeout(makeOpponentMove, 800);
      } else {
        showStatus("Your move", "info");
      }
    }

    function showStatus(message, type) {
      const alertBox = document.getElementById('puzzle-status');
      alertBox.classList.remove('d-none');
      $puzzleStatus.text(message).removeClass("correct wrong info solved").addClass(type || "");
    }

    function addToMoveHistory(move) {
      moveHistory.push({
        san: move.san,
        piece: move.piece,
        to: move.to,
        color: move.color,
        flags: move.flags
      });
      updateMoveHistory();
    }

    function formatMove(move) {
      const blackSymbols = {
        'p': '', 'n': '♘', 'b': '♗', 'r': '♖', 'q': '♕', 'k': '♔'
      };
      const whiteSymbols = {
        'p': '', 'n': '♞', 'b': '♝', 'r': '♜', 'q': '♛', 'k': '♚'
      };
      const color = move.color || 'w';
      const piece = move.piece || 'p';
      const to = move.to || '';
      const isCapture = move.flags && move.flags.includes('c');
      const symbols = color === 'w' ? whiteSymbols : blackSymbols;
      const icon = symbols[piece] || '';

      if (piece === 'p') {
        if (isCapture && move.san.length >= 4) {
          return `${move.san[0]}x${to}`;
        } else {
          return to;
        }
      }
      return `${icon}${isCapture ? 'x' : ''}${to}`;
    }

    function updateMoveHistory() {
      $moveHistory.empty();
      for (let i = 0; i < moveHistory.length; i += 2) {
        const movePair = $('<div class="move-pair d-flex gap-2"></div>');
        const moveNumber = Math.floor(i / 2) + 1;
        movePair.append(`<div class="move-number">${moveNumber}.</div>`);

        if (i < moveHistory.length) {
          const whiteMove = moveHistory[i];
          const whiteMoveElement = $(`<div class="move-white">${formatMove(whiteMove)}</div>`);
          movePair.append(whiteMoveElement);
        }
        if (i + 1 < moveHistory.length) {
          const blackMove = moveHistory[i + 1];
          const blackMoveElement = $(`<div class="move-black">${formatMove(blackMove)}</div>`);
          movePair.append(blackMoveElement);
        }
        $moveHistory.append(movePair);
      }
    }

    $buttons.on('click', function () {
      loadPuzzle($(this).data('index'));
    });

    $nextBtn.on('click', function () {
      let next = currentPuzzleIndex + 1;
      if (next >= $buttons.length) next = 0;
      loadPuzzle(next);
    });

    $resetBtn.on('click', function () {
      if (currentFen) {
        loadPuzzle(currentPuzzleIndex);
      }
    });

    $hintBtn.on('click', function () {
      if (currentMoveIndex < currentSolutionMoves.length) {
        showStatus(`Hint: ${currentSolutionMoves[currentMoveIndex]}`, "info");
      }
    });

    const lastPuzzleId = localStorage.getItem('lastPuzzleId');
    if (lastPuzzleId) {
      const lastPuzzleButton = $(`.puzzle-btn[data-puzzle-id="${lastPuzzleId}"]`);
      if (lastPuzzleButton.length) {
        loadPuzzle(lastPuzzleButton.data('index'));
      } else {
        if ($buttons.length > 0) {
          loadPuzzle(0);
        }
      }
    } else {
      if ($buttons.length > 0) {
        loadPuzzle(0);
      }
    }
  });
</script>
{% endblock %}